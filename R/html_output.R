
#' Create HTML output
#'
#' Create HTML output for display within an R Markdown document, the RStudio
#' Viewer pane, or an external web browser.
#'
#' @param html HTML output
#' @param dependencies List of HTML output dependencies (creating using
#'   \code{\link{html_dependency}})
#' @param x Object to print as HTML
#'
#' @return Object of class \code{html_output} that when printed will render in a
#'   browser (either in RStudio or extenally) and when printed from within an R
#'   Markdown document will render inline.
#'
#' @details See the documentation on
#'   \href{http://rmarkdown.rstudio.com/developer_custom_html_output.html}{R
#'   Markdown Custom HTML Output} for examples and additional details.
#'
#' @export
html_output <- function(html, dependencies) {

  # add flag indicating this is html (same as shiny does)
  attr(html, "html") <- TRUE

  # add dependencies
  attr(html, "dependencies") <- dependencies

  # add html_output and html classes (html is used by shiny)
  class(html) <- c("html_output", "html", "character")

  html
}

#' @export
print.html_output <- function(x, ...) {

  # define temporary directory for output
  www_dir <- tempfile("viewhtml")
  dir.create(www_dir)

  # we want to re-use the html_dependencies_as_string function and also
  # ensure that the paths to dependencies are relative to the base
  # directory where the temp index.html is being built. to affect
  # this we setwd to the www_dir for the duration of this function
  # to a relative path
  oldwd <- setwd(www_dir)
  on.exit(setwd(oldwd), add = TRUE)

  # build the web-page
  html <- c("<!DOCTYPE html>",
            "<html>",
            "<head>",
            "<meta charset=\"utf-8\"/>",
            html_dependencies_as_character(attr(x, "dependencies"), "lib"),
            "</head>",
            "<body>",
            x,
            "</body>",
            "</html>")

  # write it
  index_html <- file.path(www_dir, "index.html")
  writeLines(html, index_html, useBytes = TRUE)

  # show it
  viewer <- getOption("viewer")
  if (!is.null(viewer))
    viewer(index_html)
  else
    utils::browseURL(index_html)

  invisible(NULL)
}

#' @rdname html_output
#' @export
knit_print.html_output <- function(x) {
  structure(class = "knit_asis",
    x,
    knit_meta = attr(x, "dependencies")
  )
}
